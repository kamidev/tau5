<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra Background</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
        }
        canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
    </style>
    <script src="/assets/hydra_standalone.js"></script>
</head>
<body>
    <canvas id="hydra-canvas"></canvas>
    <script>
        // Get the canvas and set initial dimensions
        const canvas = document.getElementById('hydra-canvas');
        const initialWidth = window.innerWidth * window.devicePixelRatio;
        const initialHeight = window.innerHeight * window.devicePixelRatio;

        // Set canvas dimensions explicitly
        canvas.width = initialWidth;
        canvas.height = initialHeight;

        // Initialize Hydra with full resolution
        var hydra = new Hydra({
            canvas: canvas,
            detectAudio: false,
            enableStreamCapture: false,
            width: initialWidth,
            height: initialHeight
        });

        // Set canvas to full resolution
        function setCanvasResolution() {
            const canvas = document.getElementById('hydra-canvas');
            const width = window.innerWidth * window.devicePixelRatio;
            const height = window.innerHeight * window.devicePixelRatio;
            canvas.width = width;
            canvas.height = height;
            return { width, height };
        }

        // Default Hydra sketch
        function runDefaultSketch() {
            // Simple colorful Hydra sketch
            // Creates flowing gradients with rotation
            const defaultCode = `osc(10, 0.1, 1.2)
                .color(0.9, 0.7, 0.8)
                .diff(osc(12, 0.08)
                    .rotate(0.3))
                .modulateScale(osc(2)
                    .rotate(() => time * 0.05), 0.5)
                .blend(o0, 0.4)
                .out(o0)`;

            eval(defaultCode);
            // Save as current sketch so it persists through resize
            window.currentSketch = defaultCode;
        }

        // Function to update Hydra sketch with new code
        function updateSketch(code) {
            try {
                // Clear all outputs first
                solid(0, 0, 0, 0).out(o0);
                solid(0, 0, 0, 0).out(o1);
                solid(0, 0, 0, 0).out(o2);
                solid(0, 0, 0, 0).out(o3);

                // Evaluate the new sketch code
                eval(code);

                // Save the current sketch code for resize events
                window.currentSketch = code;

                // Notify parent that sketch was updated successfully
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'hydra_success',
                        message: 'Sketch updated successfully'
                    }, '*');
                }
            } catch (error) {
                console.error('Error updating Hydra sketch:', error);

                // Notify parent of error
                if (window.parent) {
                    window.parent.postMessage({
                        type: 'hydra_error',
                        error: error.toString()
                    }, '*');
                }

                // Fallback to default sketch on error
                runDefaultSketch();
            }
        }

        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            // Handle sketch update messages
            if (event.data.type === 'update_sketch' && event.data.code) {
                updateSketch(event.data.code);
            }
        });

        // Signal that Hydra is ready
        window.addEventListener('load', function() {
            if (window.parent) {
                window.parent.postMessage({
                    type: 'hydra_ready'
                }, '*');
            }
        });

        // Run default sketch on initialization
        runDefaultSketch();

        // Handle window resize to maintain resolution
        window.addEventListener('resize', function() {
            const canvas = document.getElementById('hydra-canvas');
            const width = window.innerWidth * window.devicePixelRatio;
            const height = window.innerHeight * window.devicePixelRatio;

            // Update canvas dimensions
            canvas.width = width;
            canvas.height = height;

            // Save the current sketch if it exists
            const currentSketch = window.currentSketch;

            // Reinitialize Hydra with new dimensions
            hydra = new Hydra({
                canvas: canvas,
                detectAudio: false,
                enableStreamCapture: false,
                width: width,
                height: height
            });

            // Immediately restore the sketch if it existed
            if (currentSketch) {
                try {
                    eval(currentSketch);
                } catch (e) {
                    console.error('Error restoring sketch after resize:', e);
                    // Fall back to default sketch if restoration fails
                    runDefaultSketch();
                }
            } else {
                // No custom sketch was running, use default
                runDefaultSketch();
            }
        });
    </script>
</body>
</html>